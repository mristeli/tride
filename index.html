<html>
<head>
<script type="text/javascript" src="objects.js"></script>
<script type="text/javascript">
	const objects = getObjects();
	
	function multiplyMatrixVector(v, mat) {
		const x = v.x * mat[0] + v.y * mat[4] + v.z * mat[8] + mat[12];
		const y = v.x * mat[1] + v.y * mat[5] + v.z * mat[9] + mat[13];
		const z = v.x * mat[2] + v.y * mat[6] + v.z * mat[10] + mat[14];
		const w = v.x * mat[3] + v.y * mat[7] + v.z * mat[11] + mat[15];
		if(w != 0 && w != 1) {
			return new Vector(x / w, y / w, z / w);
		}
		return new Vector(x, y, z);
	}
	
	function initializeEngine(canv) {
		setInterval(renderScene, 10, canv);
		setInterval(function(inc) {
			angle += inc;
			if(angle > Math.PI * 6) angle -= Math.PI * 6;
		}, 50, 0.1);
		renderScene(canv);
	}
	
	const fps = (function() {
		const times = [];
		return function() {
			const now = performance.now();
  	    	while (times.length > 0 && times[0] <= now - 1000) {
  	    		times.shift();
			}
  	    	times.push(now);
			return times.length;
		}
	})();
	
	const zNear = 0.1;
	const zFar = 1000;
	const fov = 90;
	
	const fovRad = 1.0 / Math.tan(fov * Math.PI / 180 / 2);
	const q = zFar / ( zFar - zNear);
	
	var angle = 0;
	
	var camera = new Vector(0, 0, 0);

	function renderScene(canv) {
		var context = canv.getContext("2d");

		context.fillStyle = "#000000";
		context.fillRect(0, 0, canv.width, canv.height);
		
		context.fillStyle = "#FFFFFF";		
		context.font = "12px Arial";
		context.fillText("FPS " + fps(), 5, 12);
	
		var scene = [
			/*{ "mesh" : objects["cube2"],
			  "size" : 1,
			  "pos" : [0, 0, 15] },,
			{"mesh" : objects["cube2"],
			  "size" : 1,
			"pos" : [-10, -4, 15] },*/ 
			{ "mesh" : objects["teapot"],
			  "size" : 1,
			"pos" : [0, 0, 5] }
		];
		
		const aspectRatio = canv.height / canv.width;
		
		const rotZ = angle/3;
		const rotX = angle;  
		
		const cos = Math.cos(rotX);
		const sin = Math.sin(rotX); 
		
		const cos2 = Math.cos(rotZ);
		const sin2 = Math.sin(rotZ);
		
		const matRot = [
			cos2, - sin2 * cos, sin * sin2, 0,
			sin2, cos * cos2, cos2 * (- sin), 0,
			0, sin, cos, 0,
			0, 0, 0, 1
		]
		const matProj = [ 
			aspectRatio * fovRad, 0, 0, 0, 
			0, fovRad, 0, 0,
		  	1, 1, q, 1,
			0, 0, - q * zNear, 0
		];
		
		context.lineWidth = 1;
		context.strokeStyle = "#FF00FF";
		
		scene.forEach(function(obj) {
			var mesh = obj["mesh"];
			if(obj["size"] != 1) {
				mesh = mesh.scale(obj["size"]);
		 	}
			const pos = obj["pos"];
			
			mesh = mesh.matrixMultiply(matRot)
				.translate(pos[0], pos[1], pos[2])
				.filterNotvisible()
				.matrixMultiply(matProj);

			mesh.tris.forEach(function(tri) {				
				tri.v1.x *= canv.width / 2;	tri.v1.y *= canv.height / 2;
				tri.v2.x *= canv.width / 2; tri.v2.y *= canv.height / 2; 
				tri.v3.x *= canv.width / 2; tri.v3.y *= canv.height / 2;
				
				context.beginPath();
				context.moveTo(tri.v1.x, tri.v1.y);			
				context.lineTo(tri.v2.x, tri.v2.y);
				context.lineTo(tri.v3.x, tri.v3.y);
				context.closePath();
				context.stroke();
			});
		})
	}
		
	function Vector(_x, _y, _z) {
		this.x = _x;
		this.y = _y;
		this.z = _z;
		
		Vector.prototype.dirVecFrom = function(other) {
			return new Vector(this.x - other.x, this.y - other.y, this.z - other.z);
		}
		
		Vector.prototype.cross = function(other) {
			return new Vector(this.y * other.z - this.z * other.y, 
				this.z * other.x - this.x * other.z, this.x * other.y - this.y * other.x);
		}
		
		Vector.prototype.dot = function(other) {
			return this.x * other.x + this.y * other.y 
				+ this.z * other.z;
		}
		
		Vector.prototype.normalize = function() {
			var mag = Math.sqrt(this.x*this.x + this.y*this.y + this.z*this.z); 
			return new Vector(this.x / mag, this.y / mag, this.z / mag);
		}
		
		Vector.prototype.translate = function(i, j = 0, k = 0) {
			return new Vector(this.x + i, this.y + j, this.z + k);
		}
	}
	
	function Triangle (_v1, _v2, _v3) {
		this.v1 = _v1;
		this.v2 = _v2;
		this.v3 = _v3;
		
		this.normal = this.v2.dirVecFrom(this.v1).cross(this.v3.dirVecFrom(this.v1)).normalize();

		Triangle.prototype.scale = function(r) {
			return new Triangle(new Vector(this.v1.x * r, this.v1.y * r, this.v1.z * r), 
				new Vector(this.v2.x * r, this.v2.y * r, this.v2.z * r),
				new Vector(this.v3.x * r, this.v3.y * r, this.v3.z * r));
		}
		
		Triangle.prototype.translate = function(i, j = 0, k = 0) {
			return new Triangle(this.v1.translate(i, j, k), 
				this.v2.translate(i, j, k), 
				this.v3.translate(i, j, k));
		}
	}
	
	function Mesh (tris) {
		this.tris = tris;
		
		Mesh.prototype.scale = function(r) {
			return new Mesh(this.tris.map(tri => tri.scale(r)));
		}
		
		Mesh.prototype.translate = function(i, j, k) {
			return new Mesh(this.tris.map(tri => tri.translate(i, j, k)));
		}
		
		Mesh.prototype.filterNotvisible = function() {
			return new Mesh(this.tris.filter(tri => tri.normal.z < 0.0))
		}
			
		Mesh.prototype.matrixMultiply = function(matrix) {
			return new Mesh(this.tris.map(
				tri => new Triangle(
					multiplyMatrixVector(tri.v1, matrix),
					multiplyMatrixVector(tri.v2, matrix),
					multiplyMatrixVector(tri.v3, matrix))
					));
		}
	
	}
</script>
<title>pure js 3d fun</title>
</head>
<body onLoad="javascript:initializeEngine(document.getElementById('view'))">
<canvas id="view" width="640" height="480">
</canvas>
</body>
</html>